#!/bin/bash
# nvq
# Example: nvq @myscope/mypackage
#
# npm-versions-query
#
# Show current and latest version of dependencies from a package.json
#
# TODO: If $TARGET starts with `.`, it is assumed to be a path to a package manifest on the local filesystem and read from there.
#   Otherwise, it will be looked up on the $NPM_CONFIG_REGISTRY

set -e

nvs_current_and_latest () {
  SORT=$1
  PKG=$2
  CURRENT=$3

  LATEST="$(nvs ${PKG} | sort ${SORT} | tail -n2 | head -n+1 | cut -f1)"
  printf "%s\t%s\t%s\n" ${PKG} ${CURRENT} ${LATEST}
}

# https://stackoverflow.com/questions/11003418/calling-shell-functions-with-xargs
export -f nvs_current_and_latest


CONCURRENCY=8
SECTION=dependencies
TARGET=./package.json
SORT=-z

while getopts "h?DdPprt:" opt; do
  case "$opt" in
    h|\?)
      echo rtfs
      exit 1
      ;;
    D)  SECTION=devDependencies
      ;;
    P)  CONCURRENCY=$OPTARG
      ;;
    p)  SECTION=peerDependencies
      ;;
    r)  NPM_CONFIG_REGISTRY=$OPTARG
      ;;
    t)  TARGET=$OPTARG
      ;;
    # Show latest by version, not by publish date like default
    V)  SORT=-V
      ;;
  esac
done

jq -r ".${SECTION}|to_entries|map(.key,.value)|.[]" ${TARGET} \
  | xargs -P${CONCURRENCY} -n2 bash -c "nvs_current_and_latest ${SORT} \$0 \$1" \
  | sort | column -t
